<style scoped>
    .config_main{
        padding:20px;
        background: #fff;
    }
    .config_main .block{
        display: flex;
        flex-direction: row;
        align-items: center;
        flex-wrap: wrap;
    }
    .config_main .block .left{
        width:150px;
        color:#666;
    }
    .config_main .block .right{
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    .config_main .block .inp1{
        width:380px;
    }
    .config_main .block .inp2{
        width:180px;
    }
    .config_main .block .textarea{
        width:800px;
    }
    .config_main .btns_submit{
        padding:50px 0 100px 0;
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    .lable_parent{
        position: relative;
    }
    .lable_parent .delete{
        position: absolute;
        right:20px;
        top:0;
    }
</style>
<div class="content" id="team" v-cloak>
    <el-row>
        <el-col :span="12">
            <div class="grid-content bg-purple com_title">应用构建配置</div>
        </el-col>
    </el-row>
    <div class="config_main mt30">
        <div class="block mb50">
            <div class="bottom">
                <div class="top mb20">资产列表</div>
                <el-table :data="assetslist" border style="width:1000px;font-size:12px;">
                    <el-table-column prop="name" label="资产名称" width="200">
                    </el-table-column>
                    <el-table-column prop="outer_ip" label="外网IP" width="150">
                    </el-table-column>
                    <el-table-column prop="lan_ip" label="内网IP" width="150">
                    </el-table-column>
                    <el-table-column prop="user" label="用户名" width="80">
                    </el-table-column>
                    <el-table-column label="操作">
                        <template slot-scope="scope">
                            <div>
                                <el-button @click="checkGit(scope.row)" type="info" size="mini" plain>检测GIT环境</el-button>
                                <el-button @click="installGit(scope.row)" type="primary" size="mini" plain>安装GIT环境</el-button>
                                <el-button @click="showSshKey(scope.row)" type="danger" size="mini" plain>获得SSH KEY</el-button>
                            </div>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
        <div class="block mb50">
            <el-button type="primary" icon="el-icon-plus" @click="addNewTask" class="ml30">新建任务</el-button>
        </div>
        <el-tabs 
            v-model="editableTabsValue" 
            closable 
            type="border-card"
            v-if="tasklist.length" 
            @tab-remove="removeTab">
            <el-tab-pane 
                class="lable_parent" 
                v-for="(item,index) in tasklist" 
                :key="index" 
                :label="item.task_name" 
                :name="index+''">
                <div class="delete">
                    <el-button type="danger" icon="el-icon-delete" size="medium" @click="deleteItemTask(item,index)" class="ml30">删除此任务</el-button>
                </div>
                <div class="block mt30">
                    <div class="left">任务名称</div>
                    <div class="right">
                        <el-input v-model="item.task_name" class="inp1"></el-input>
                    </div>
                </div>
                <div class="block mt30">
                    <div class="left">任务类型</div>
                    <div class="right">{{item.task_type=='git'?'git hooks任务':''}}{{item.task_type=='shell'?'shell脚本任务':''}}</div>
                </div>
                <div v-show="item.task_type=='git'?true:false">
                    <div class="block mt30">
                        <div class="left">选择git部署方式</div>
                        <div class="right">
                            <el-button :type="item.git_type=='https'?'primary':'default'" size="small" @click="item.git_type='https'" round>https方式
                            </el-button>
                            <el-button :type="item.git_type=='ssh'?'primary':'default'" size="small" @click="item.git_type='ssh'" class="ml30" round>
                                ssh方式</el-button>
                        </div>
                    </div>
                    <div v-show="item.git_type=='https'?true:false">
                        <div class="block mt20">
                            <div class="left"></div>
                            <div class="right">
                                <el-input v-model="item.git_url" class="inp1" placeholder="请输入git https地址"></el-input>
                            </div>
                        </div>
                        <div class="block mt20">
                            <div class="left"></div>
                            <div class="right">
                                <el-input v-model="item.git_user" class="inp2" placeholder="请输入git用户名"></el-input>
                                <el-input v-model="item.git_pwd" class="ml20 inp2" placeholder="请输入git密码"></el-input>
                            </div>
                        </div>
                    </div>
                    <div v-show="item.git_type=='ssh'?true:false">
                        <div class="block mt20">
                            <div class="left"></div>
                            <div class="right">
                                <el-input v-model="item.git_url" class="inp1" placeholder="请输入git ssh地址"></el-input>
                                <span class="ml20 light">备注：请确保git平台应用项目已经添加了相应服务器的ssh key。</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="block mt30">
                    <div class="left">服务器部署shell脚本</div>
                    <div class="right">
                        <el-input v-model="item.shell_path" class="inp1" placeholder="例如：/data/src/build.sh"></el-input>
                        <span class="ml20 light">备注：若服务器目录或文件不存在则自动创建。</span>
                    </div>
                </div>
                <div class="block mt30">
                    <div class="left">部署shell脚本</div>
                    <div>
                        <!-- <el-button type="primary" size="small" round>随机从资产列表中同步shell脚本</el-button> -->
                        <div class="mt10 right">
                            <el-input type="textarea" :rows="15" placeholder="部署shell脚本" v-model="item.shell_body" style="width:1000px;">
                            </el-input>
                        </div>
                        <div class="mt10 light">备注：服务器初始shell脚本。</div>
                    </div>
                </div>
            </el-tab-pane>
        </el-tabs>
        <div class="btns_submit" v-if="tasklist.length">
            <el-button type="primary" @click="submitConfigs" class="mb20">保存构建配置</el-button>
            <el-button type="default" @click="goBack" class="mb20">取消</el-button>
        </div>
        
        <!-- 新建任务model -->
        <el-dialog width="600px" title="新建任务" :visible.sync="dialogTableVisible">
            <div class="com_model_main">
                <div class="com_model_block">
                    <div class="left">任务名称</div>
                    <el-input class="inp" v-model.trim="task_name" placeholder="请输入任务名称"></el-input>
                </div>
                <div class="com_model_block">
                    <div class="left">任务类型</div>
                    <el-select class="inp" v-model="task_type" placeholder="请选择">
                        <el-option v-for="item in options" :key="item.value" :label="item.label" :value="item.value">
                        </el-option>
                    </el-select>
                </div>
                <div class="btns">
                    <el-button type="primary" @click="submitTask"> 提交 </el-button>
                </div>
            </div>
        </el-dialog>

        <!-- ssk 弹出框 -->
        <el-dialog width="800px" title="SSH KEY" :visible.sync="sshkey.dialogSshKeyVisible">
            <div class="com_model_main">
                <div class="mb20 common_tops"><i class="el-icon-warning"></i>请尽量使用获得ssh key按钮，若生成新的ssh key则相关地方均需要更改（例如：github ssk）</div>
                <div>
                    <el-button @click="getSshKey(1)" type="primary" plain>获得SSH KEY</el-button>
                </div>
                <div class="block mt30">
                    <div class="left" style="width:80px;">邮箱地址</div>
                    <div class="right">
                        <el-input v-model="sshkey.email" style="width:200px;margin-right:15px;" placeholder="用来生成ssh key的邮箱备注"></el-input>
                        <el-button @click="getSshKey(2)" class="ml10" type="danger" plain>生成新的SSH KEY</el-button>
                    </div>
                </div>
                <div class="mt30 mb20">ssh key</div>
                <el-input type="textarea" :rows="6" v-model="sshkey.sshKey"></el-input>
            </div>
        </el-dialog>

    </div>
</div>
<script>
    new Vue({
        el: '#team',
        data: function () {
            return {
                id: util.getQueryString('id'),
                details:{},
                assetslist:[],
                dialogTableVisible:false,
                options:[{
                    value: 'git',
                    label: 'GIT任务'
                },{
                    value: 'shell',
                    label: 'SHELL任务'
                }],
                task_name:'',
                task_type: '',
                tasklist:[],
                editableTabsValue: 0,
                sshkey:{
                    dialogSshKeyVisible: false,
                    sshKey: '',
                    email:'',
                    assetsItem: {},
                },
            }
        },
        mounted() {
            this.itemdetail();
        },
        methods: {
            itemdetail(){
                util.ajax({
                    type: 'get',
                    url: `${config.baseApi}api/v1/application/itemdetail`,
                    data: {
                        id: this.id,
                    },
                    success: data => {
                        this.details = data.data;
                        this.assetslist = data.data.assets_list || [];
                        this.tasklist = data.data.task_list || [];
                    }
                })
            },
            addNewTask(){
                this.task_type = '';
                this.task_name = '';
                this.dialogTableVisible = true;
            },
            submitTask(){
                if(!this.task_name){
                    popup.alert({title:'请填写任务名称!'})
                    return;
                }
                if (!this.task_type) {
                    popup.alert({ title: '请选择任务类型!' })
                    return;
                }
                this.dialogTableVisible = false;
                this.editableTabsValue = this.tasklist.length + '';
                this.tasklist.push({
                    task_name:this.task_name,
                    task_type: this.task_type,
                    git_type:'https',
                })
            },
            removeTab(targetName){
                popup.confirm({title: `确定删除此任务吗？`, yes: () => {
                    let tabs = this.tasklist;
                    let activeName = this.editableTabsValue;
                    if (activeName == targetName) {
                        tabs.forEach((tab, index) => {
                            if (tab.name === targetName) {
                                let nextTab = tabs[index + 1] || tabs[index - 1];
                                if (nextTab) {
                                    activeName = nextTab.name;
                                }
                            }
                        });
                    }
                    this.editableTabsValue = activeName;
                    this.tasklist = tabs.filter((tab,index) => index != targetName);
                }})
            },
            deleteItemTask(item,index){
                popup.confirm({ title: `确定删除${item.task_name}任务吗？`, yes: () => {
                    this.editableTabsValue = '0';
                    this.tasklist.splice(index, 1);
                }})
            },
            goBack(){
                location.href="/application"
            },
            checkGit(item){
                util.ajax({
                    url: `${config.baseApi}api/v1/util/checkGitEnviron`,
                    data: {
                        host: item.outer_ip,
                        port: item.port,
                        username: item.user,
                        password: item.password,
                    },
                    success: data => {
                        if(data.data) {
                            const version = data.data.match(/\d[\d\.]+\d/)[0]
                            popup.miss({title:'检测到服务器已安装GIT 环境版本为'+ version})
                        }else{
                            popup.miss({ title: '检测到服务器未安装GIT环境！' })
                        }
                    }
                })
            },
            installGit(item) {
                popup.confirm({
                    title: `确定为${item.name}安装GIT环境吗？`, yes: () => {
                        util.ajax({
                            url: `${config.baseApi}api/v1/util/installGitEnviron`,
                            data: {
                                host: item.outer_ip,
                                port: item.port,
                                username: item.user,
                                password: item.password,
                            },
                            success: data => {
                                if (data.data) {
                                    popup.miss({ title: '安装成功！'})
                                } else {
                                    popup.miss({ title: '安装失败!' })
                                }
                            }
                        })
                    }
                })
            },
            submitConfigs(){
                util.ajax({
                    url: `${config.baseApi}api/v1/application/updateConfigs`,
                    data: {
                        id:this.id,
                        tasklist:this.tasklist,
                    },
                    success: data => {
                        this.itemdetail();
                        popup.miss({title:'操作成功!'})
                    }
                })
            },
            showSshKey(item) {
                if (this.sshkey.assetsItem._id !== item._id) this.sshkey.sshKey = '';
                this.sshkey.assetsItem = item;
                this.sshkey.dialogSshKeyVisible = true;
            },
            getSshKey(type){
                util.ajax({
                    url: `${config.baseApi}api/v1/util/getAssetSshKey`,
                    data: {
                        type: type,
                        email:this.sshkey.email,
                        host: this.sshkey.assetsItem.outer_ip,
                        port: this.sshkey.assetsItem.port,
                        username: this.sshkey.assetsItem.user,
                        password: this.sshkey.assetsItem.password,
                    },
                    success: data => {
                        this.sshkey.sshKey = data.data;
                    }
                })
            },
        }
    })
</script>